<!doctype html>
<head>
  <title>Polymorphic Pattern Sphere Schema</title>
  <style>
    h1, h2 {
	font-family: sans-serif;
    }
    dt {
	font-weight:bold;
	margin-left: 1em;
    }
    pre {
	margin-left: 1em;
    }
  </style>
</head>
<body>

<h1>Polymorphic Pattern Sphere Schema</h1>

<p>The Public Sphere Project is in the early stages of working toward
building tools and data representations for pattern languages of many
types. This document describes our current testbed and specifically
the schema of the SQL database design we are using.</p>

<p>Key elements are missing!</p>

<p>Our strategy for data representation has these elements:</p>

<dl>
  
 <dt>pattern feature</dt>
 <dd>A <em>pattern feature</em> has a name and a type. For example, the
   <code>title</code> is of type <code>string</code>. Other types
   that a feature may have are <code>image</code>. Feature names must be
   unique.</dd>

 <dt>pattern template</dt>
 <dd>A <em>pattern template</em> is a named collection of features.
   Features in a template may be required.</dd>

 <dt>pattern</dt>
 <dd>A <em>pattern</em> has an associated <em>pattern template</em> that
   defines what features it may have.</dd>
 
 <dt>feature value</dt>
 <dd>Our data design calls for a distinct database table for each pattern
   feature, used to store feature values. We follow a table naming convention
   based on the feature name. For example, the table storing values for the
   <code>title</code> feature is <code>pf_title</code>, which has
   a <code>value</code> column suitable for storing strings.</dd>

 <dt>pattern language</dt>
 <dd>A <em>pattern language</em> is a collection of <em>patterns</em>, which
  share a <em>pattern template</em>.</dd>

<dt>pattern view</dt>
 <dd>A <em>pattern view</em> is an ordered set of <em>pattern
   features</em> sharing a common <em>pattern template</em>. The
   concept here is to draw upon a subset of pattern features to present
   a set of <em>patterns<em> in a particular context, such as displayed
   on a screen for assessment or printed on a set of cards.</dd>

<!-- <dt></dt>
 <dd></dd>-->

</dl>

<h2>Schema</h2>

<p>Here is an ordered list of tables:</p>
<ul>
 <li><a href="#pattern_template">pattern_template</a></li>
 <li><a href="#language">language</a></li>
 <li><a href="#pattern">pattern</a></li>
 <li><a href="#pattern_feature">pattern_feature</a></li>
 <li><a href="#pattern_language">pattern_language</a></li>
 <li><a href="#pattern_note">pattern_note</a></li>
 <li><a href="#pattern_template">pattern_template</a></li>
 <li><a href="#pattern_view">pattern_view</a></li>
 <li><a href="#pattern_view_feature_position">pattern_view_feature_position</a></li>
 <li><a href="#plmember">plmember</a></li>
  <li><a href="#pt_feature">pt_feature</a></li>
</ul>

<p id="pattern_template">A <code>pattern_template</code> is a named set of
<code>pattern_feature</code> elements. As with many other tables,
the <code>notes</code> is for author annotation and the <code>created</code>
and <code>modified</code> columns document (a little bit of) the history.</p>

<pre>
CREATE TABLE pattern_template (
  id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,
  name varchar(255) NOT NULL UNIQUE,
  notes varchar(16383) DEFAULT NULL,
  created timestamp NOT NULL DEFAULT current_timestamp(),
  modified timestamp NOT NULL DEFAULT current_timestamp()
   ON UPDATE current_timestamp()
)
</pre>

<p id="pattern">Each row in the <code>pattern</code> table represents
- surprise! - a pattern. The <code>ptid</code>, linking to
a <code>pattern_template</code>, defines the features it may have.</p>

<pre>
CREATE TABLE pattern (
  id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,
  ptid int unsigned NOT NULL,
  notes varchar(16383),
  created timestamp NOT NULL DEFAULT current_timestamp(),
  modified timestamp NOT NULL DEFAULT current_timestamp()
   ON UPDATE current_timestamp(),
  CONSTRAINT FOREIGN KEY (ptid) REFERENCES pattern_template(id)
   ON DELETE CASCADE
);
</pre>

<p id="language">The <code>language</code> is a lookup table for
  natural languages, intended to support internationalization but not
  yet used and subject to refinement. US English, coded
  as <code>en</code>, is the default language.</p>

<pre>
CREATE TABLE language (
  code CHAR(2) NOT NULL,
  description varchar(255) NOT NULL,
  PRIMARY KEY (code)
);
</pre>

<p id="pattern_note">Not yet used, each row in the <code>pattern_note</code>
table is a translation of a <code>pattern.note</code> value.</p>

<pre>
CREATE TABLE pattern_note (
  note TINYTEXT NOT NULL,
  pid int unsigned NOT NULL,
  language CHAR(2) NOT NULL DEFAULT 'en',
  created timestamp NOT NULL DEFAULT current_timestamp(),
  modified timestamp NOT NULL DEFAULT current_timestamp()
   ON UPDATE current_timestamp(),
  CONSTRAINT FOREIGN KEY(language) REFERENCES language(code),
  CONSTRAINT FOREIGN KEY(pid) REFERENCES pattern(id)
);
</pre>

<p id="pattern_language">A <code>pattern_language</code> is a named set of
patterns that share a <code>pattern_template</code>.</p>

<pre>
CREATE TABLE pattern_language (
  id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,
  ptid int unsigned NOT NULL,
  name varchar(255) NOT NULL UNIQUE,
  notes varchar(16383),
  created timestamp NOT NULL DEFAULT current_timestamp(),
  modified timestamp NOT NULL DEFAULT current_timestamp()
   ON UPDATE current_timestamp(),
  CONSTRAINT FOREIGN KEY(ptid) REFERENCES pattern_template(id)
);
</pre>

<p id="pattern_feature">A row in the <code>pattern_feature</code>
  defines a named and typed feature that a <code>pattern</code> may
  have. The <code>required</code> is true if each pattern
  that <em>may</em> have the feature <em>must</em> have that
  feature. (Arguably, this would better be a column in
  the <a href="#pt_feature"><code>pt_feature</code></a> table, but
  that's not the current design.)
</p>

<pre>
CREATE TABLE pattern_feature (
  id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,
  name varchar(255) NOT NULL UNIQUE,
  type enum('string', 'text', 'image', 'integer'),
  required tinyint(1) DEFAULT 0,
  notes varchar(16383) DEFAULT NULL,
  created timestamp NOT NULL DEFAULT current_timestamp(),
  modified timestamp NOT NULL DEFAULT current_timestamp()
   ON UPDATE current_timestamp()
);
</pre>

<p id="pt_feature">Each row in <code>pt_feature</code> specifies
a <code>pattern_feature</code> that is linked to
a <code>pattern_template</code> - that is, a feature that a pattern
using that template may have.</p>

<pre>
 CREATE TABLE pt_feature (
  id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,
  ptid int unsigned NOT NULL,
  fid int unsigned NOT NULL,
  created timestamp NOT NULL DEFAULT current_timestamp(),
  modified timestamp NOT NULL DEFAULT current_timestamp()
   ON UPDATE current_timestamp(),
  CONSTRAINT UNIQUE (ptid, fid),
  CONSTRAINT FOREIGN KEY(ptid) REFERENCES pattern_template(id)
   ON DELETE CASCADE,
  CONSTRAINT FOREIGN KEY(fid) REFERENCES pattern_feature(id)
   ON DELETE CASCADE
 );
</pre>

<p id="plmember">Each row in the <code>plmember</code> table specifies a
  <code>pattern</code> and a <code>pattern_language</code>, specifying
  that the referenced pattern language includes that pattern.</p>

<pre>
CREATE TABLE plmember (
  pid int unsigned NOT NULL,
  plid int unsigned NOT NULL,
  CONSTRAINT UNIQUE(plid, pid),
  FOREIGN KEY (pid) REFERENCES pattern(id),
  FOREIGN KEY (plid) REFERENCES pattern_language(id)
);
</pre>

<p id="pattern_view">A <code>pattern_view</code> is, in combination
  with rows
  in <a href="#pattern_view_feature_position">pattern_view_feature_position<code></a>,
  a named ordering of the features in a pattern template.</p>

<pre>
CREATE TABLE pattern_view (
  id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,
  ptid int unsigned NOT NULL,
  name varchar(255) NOT NULL,
  created timestamp NOT NULL DEFAULT current_timestamp(),
  modified timestamp NOT NULL DEFAULT current_timestamp()
   ON UPDATE current_timestamp(),
  notes varchar(16383),
  CONSTRAINT FOREIGN KEY (ptid) REFERENCES pattern_template(id)
);
</pre>

<p id="pattern_view_feature_position">Rows in this table specify the ordering
  of pattern features from a template that can be used to display patterns
  using that template.</p>

<pre>
CREATE TABLE pattern_view_feature_position (
  id int unsigned NOT NULL AUTO_INCREMENT PRIMARY KEY,
  pfid int unsigned NOT NULL,
  pvfp int unsigned NOT NULL,
  `order` int unsigned NOT NULL UNIQUE,
  CONSTRAINT FOREIGN KEY(pfid) REFERENCES pattern_feature(id),
  CONSTRAINT FOREIGN KEY(pvfp) REFERENCES pattern_view(id)
);
</pre>

</body>
</html>
